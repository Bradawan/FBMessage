<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-time.v1.min.js"></script>
  <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
  <style>
  </style>
</head>

<body>

  <div id="container"></div>

  <script>
  var margin = {
                top: 20,
                right: 20,
                bottom: 50,
                left: 70
                  };

  var width = 1400;
  var height = 1000;

  var w1 = 0.7 * width - margin.left - margin.right
  var h1 = 0.8 * height - margin.top - margin.bottom
  var w2 = 0.7 * width - margin.left - margin.right
  var h2 = 0.2 * height - margin.top - margin.bottom
  var w3 = 0.7 * width - margin.left - margin.right
  var h3 = 1.0 * height - margin.top - margin.bottom
  var parseUTCDateHour = d3.timeParse("%Y-%m-%dT%H:%M%Z");
  var parseUTCDate = d3.timeParse("%Y-%m-%d");


  // y scale
  var y1 = d3.scaleLinear()
            .domain([0,24])
            .range([0,height]);

  var y2 = d3.scaleLinear()
            .domain([0,24])
            .range([0,h2]);

  // x scale
  var mindate = new Date(2010,0,1),
      maxdate = new Date(2019,11,31);


  var x1 = d3.scaleTime()
            .range([0, width]);

  var x2 = d3.scaleTime()
            .range([0, w2]);




    var canvas = d3.select('#container')
      .append('canvas')
      .attr('width', width)
      .attr('height', height);



    var customBase = document.createElement('custom');
    var custom = d3.select(customBase);
    // This is your SVG replacement and the parent of all other elements
    var context = canvas.node().getContext('2d');




    var data =  d3.json("flat_messages.json", function(json){


      // Parse the Date
      getDate = function(date){
        string = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate();
        return parseUTCDate(string);
      }

      getTime = function(date){ //Remove the ":" in order to match the correct format
        return date.getHours() + date.getMinutes()/60;
      };


      json.data.forEach(function(element){
        date = element.date
        date = parseUTCDateHour(date.substring(0, date.length - 3) + date.substring(date.length - 2, date.length))
        element.time = getTime(date);
        element.date = getDate(date);
      });





              var mindate_total = d3.min(json.data, function(d){return d.date}),
                  maxdate_total = d3.max(json.data, function(d){return d.date});
            // Create the SVG

              x1.domain([mindate_total, maxdate_total]);
            // moves the 'group' element to the top left margin


    function databind(data){

      var join = custom.selectAll("custom.circle")
            .data(json.data.filter(function(element){
                return (element.date < maxdate && element.date > mindate);
            }));

      var enterSel = join.enter()
        .append('custom')
        .attr('class', 'circle')
        .attr("x", function(d, i) {
          return x1(d.date); })
        .attr("y", function(d, i) {
          return y1(d.time)})
        .attr("radius", 2)
        .attr('fillStyle', "red");

      var exitSel = join.exit()
        .transition()
        .attr('width', 0)
        .attr('height', 0)
        .remove();



    };

    function draw() {
        context.clearRect(0, 0, width, height); // Clear the canvas.
        // Draw each individual custom element with their properties.
        var elements = custom.selectAll('custom.circle');
        // Grab all elements you bound data to in the databind() function.
        elements.each(function(d,i) { // For each virtual/custom element..

          var node = d3.select(this);


          function drawCircle(context, radius) {
            context.moveTo(radius, 0);
            context.arc(0, 0, radius, 0, 2 * Math.PI);
          };

          //context.fillRect(40, 40, 40, 40);
          // This is each individual element in the loop.

        //  context.fillStyle = node.attr('fillStyle');
          // Here you retrieve the colour from the individual in-memory node and set the fillStyle for the canvas paint
  /*        context.fillStyle = "#FF4422";
          context.beginPath();
          context.arc(40, 40, 40, 0, 2 * Math.Pi, true);
          context.fill();
		      context.closePath();
          context.stroke();
  */
          //context.beginPath();
          //context.arc(x-center, y-center, radius, startAngle, endAngle, counterclockwise)
          //A circle would thus look like:
          //context.arc(node.attr("x"), node.attr("y"), node.attr("radius"), 0,  2 * Math.PI, true);
          //context.fill();
          //context.closePath();


          context.globalAlpha = 0.3;
          context.fillStyle = node.attr('fillStyle');
          context.fillRect(node.attr("x"), node.attr("y"), node.attr("radius"), node.attr("radius"));


          //context.ellipse(node.attr("x"), node.attr("y"), node.attr("radius"), node.attr("radius"));

          // Here you retrieve the position of the node and apply it to the fillRect context function which will fill and paint the square.
        }); // Loop through each element.

    };


    databind(data);
    draw();

});

  </script>
</body>
