<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-time.v1.min.js"></script>
  <script src="https://d3js.org/d3-time-format.v2.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <style>

  .area {
    fill: steelblue;
    clip-path: url(#clip);
  }

  .zoom {
    cursor: move;
    fill: none;
    pointer-events: all;
  }

  div.tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 120px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }

  .bar text {
    fill: purple;
    font: 15px sans-serif;
  }

  </style>
</head>
<body>
  <div>
    <div id="density_time" style="background-color: blue; width: 10%; height: 800px; display: inline-block;"></div>
    <div id="main" style="background-color: white; width: 70%; vertical-align: top; height: 800px; display: inline-block;">
      <canvas></canvas>
    </div>
    <div id="filters" style="background-color: green; width:19%; height: 950px; float: right; vertical-align: top; display: inline-block;"></div>
    <div id="place_holder" style="background-color: yellow; width: 10%; height: 150px; display: inline-block;"></div>
    <div id="density_date" style="background-color: red; width: 70%; height: 150px; display: inline-block;"></div>
  </div>

  <script>

var json;
// Define div, svg, etc..
{
    var div_density_time = d3.select('#density_time')
    var div_main = d3.select('#main')
    var div_filters = d3.select('#filters')
    var div_density_date = d3.select('#density_date')
    var div_offset = d3.select('#offset')

    var canvas = document.querySelector("canvas"),
        context_canvas = canvas.getContext("2d");

    var div_filters_2 = document.getElementById("filters")
    var div_main_2 = document.getElementById("main")
    var div_density_date_2 = document.getElementById("density_date")
    var div_density_time_2 = document.getElementById("density_time")

}

//Define heights and widths
{
  var margin1 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 70,
  };
  var margin2 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 70,
  };
  var margin3 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 30,
  };
  var margin4 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 70,
  };

  var width = window.innerWidth;
  var height = window.innerHeight;
  var w1 = div_main_2.clientWidth - margin1.left - margin1.right;
  var h1 = div_main_2.clientHeight - margin1.top - margin1.bottom;
  var w2 = div_density_date_2.clientWidth - margin2.left - margin2.right;
  var h2 = div_density_date_2.clientHeight - margin2.top - margin2.bottom;
  var w3 = div_filters_2.clientWidth - margin3.left - margin3.right;
  var h3 = div_filters_2.clientHeight - margin3.top - margin3.bottom;

  canvas.width = w1 + margin1.left;
  canvas.height = h1;
}

// Define div, svg, etc..
{
  var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

  var body = d3.select("body");


  var density_date = div_density_date
                        .append("svg")
                        .attr("height", (h2 + margin2.top + margin2.bottom))
                        .attr("width", (w2 + margin2.left + margin2.right))
                        //.attr("transform", "translate(0," + (h1 + margin1.top + margin1.bottom) + ")");

  var axis_focus = div_main
                    .append("svg")
                    .attr("width", (w1 + margin1.left + margin1.right))
                    .attr("height", margin1.bottom)
                    //.attr("transform", "translate(" + margin1.left + "," + (h1 + margin1.top) + ")");

  var filters = div_filters
            .append("svg")
            .attr("height", (h3 + margin3.top + margin3.bottom))
            .attr("width", (w3 + margin3.left + margin3.right))
            //.attr("transform", "translate(" + (w1 + margin1.left + margin1.right) + ", 0)");
}

//Define parsers
{
  var parseUTCDateHour = d3.timeParse("%Y-%m-%dT%H:%M%Z");
  var parseUTCDate = d3.timeParse("%Y-%m-%d");
  var parseUTCDate2 = d3.timeParse("%W-%m-%Y");
}

// Define scales and axes
{
  var y1 = d3.scaleLinear()
            .domain([0,24])
            .range([0,h1]);

  var y2 = d3.scaleLinear()
            .range([h2,0]);

  var x3 = d3.scaleLinear()
            .range([0, w3]);

  var x1 = d3.scaleTime()
            .range([0, w1]);

  var x2 = d3.scaleTime()
            .range([0, w2]);

  var y3 = d3.scaleLinear()
              .rangeRound([0,h3/3]);

  var xAxis1 = d3.axisBottom()
              .scale(x1);

  var xAxis2 = d3.axisBottom()
              .scale(x2);
}

//Defin brush and zoom
{
  var brush = d3.brushX()
      .extent([[0, margin2.top], [w2, margin2.top + h2]])
      .on("brush end", brushed);

  var zoom = d3.zoom()
    .scaleExtent([1, Infinity])
    .translateExtent([[0, margin2.top], [w2, margin2.top + h2]])
    .extent([[0, margin2.top], [w2, margin2.top + h2]])
    .on("zoom", zoomed);
}

//Load data
var data =  d3.json("short_flat_messages.json", function(json_file){

  json = json_file;
  parse_date()
  intialize_conditions()

  //initialize domains
  var mindate_total = d3.min(json.data, function(d){return d.date}),
      maxdate_total = d3.max(json.data, function(d){return d.date});

  x1.domain([mindate_total, maxdate_total]);
  x2.domain([mindate_total, maxdate_total]);

  create_scatterplot();

  axis_focus.append('g')
    .attr('transform', 'translate(' + margin1.left + ',' + 0 + ')')
    .attr('class', 'x axis--x')
    .call(xAxis1);

  draw_density();

  draw_histogram(json.data, maxdate_total, mindate_total);


  density_date.append("g")
        .attr("class", "brush")
        .call(brush)
        .call(brush.move, x2.range())
        .attr('transform', 'translate(' + margin2.left + ',' + 0 + ')');
});

function parse_date(){
json.data.forEach(function(d){
 date = d.date;
 date = parseUTCDateHour(date.substring(0, date.length - 3) + date.substring(date.length - 2, date.length));
 d.time = getTime(date);
 d.date = getDate(date);
})
};

function intialize_conditions(){
json.data.forEach(function(d){
 d._cd_date = true;
 d._cd_sent_received = true;
 d._cd_message_per_day = true;
 d._visible = true;
})
}

function update_cd_date(){
json.data.forEach(function(d){
 d._cd_date = d.date > x1.domain()[0] && d.date < x1.domain()[1]
})
}

function update_visible(){
json.data.forEach(function(d){
  d._visible = d._cd_date && d._cd_sent_received && d._cd_message_per_day;
})
}

function draw_density(){

var nested_data = d3.nest().key(function(d){
return d.date.getWeek() + '-' + d.date.getMonth() + '-' + d.date.getFullYear();})
.rollup(function(leaves) {
    return  leaves.length
})
.entries(json.data);

nested_data = nested_data.sort(sortByDateAscending);

var max_message = d3.max(nested_data, function(d){return d.value});

y2.domain([0, max_message]);

var area = d3.area()
  .curve(d3.curveBasisOpen)
  .x(function(d) { return x2(parseUTCDate2(d.key));})
  .y0(h2)
  .y1(function(d) { return y2(d.value); });

density_date.append("path")
    .datum(nested_data)
    .attr("class", "area")
    .attr("d", area)
    .attr('transform', 'translate(' + margin2.left + ',' + (margin2.top) + ')')

density_date.append('g')
  .attr('transform', 'translate(' + margin2.left + ',' + (h2 + margin2.top) + ')')
  .attr('class', 'x axis--x')
  .call(xAxis2);
}

function draw_histogram(data_hist, max_date, min_date){

  //Remove old histogram
  filters.selectAll('.bar')
     .remove();
  filters.selectAll('.y_hist')
     .remove();

  //Create nested dataset
  var nested_data_hist = d3.nest()
     .key(function(d){return d.date;})
     .rollup(function(leaves) {return leaves.length})
     .entries(data_hist.filter(function(d){return d._visible;}));

  //Define domain vertical axis
  var min_num = d3.min(nested_data_hist, function(d){return d.value}),
      max_num = d3.max(nested_data_hist, function(d){return d.value});

  y3.domain([min_num,max_num]);

  var histogram = d3.histogram()
     .value(function(d) {return +d.value;})
     .domain(y3.domain())
     .thresholds(y3.ticks(10));

  var bins = histogram(nested_data_hist);

  x3.domain([0, d3.max(bins, function(d) { return d.length; })])

  var bar = filters.selectAll(".bar")
   .data(bins)
   .enter().append("g")
     .attr("class", "bar")
     .attr("transform", function(d) { return "translate(" + 0 + "," + y3(d.x0) + ")"; });

  var clicked_rect = null;

  bar.append("rect")
     .style("fill", "steelblue")
     .attr("y", 1)
     .attr("height", y3(bins[0].x1) - y3(bins[0].x0) - 1)
     .attr("width", function(d) {return x3(d.length); })
     .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")")
     .on("click", function(d){
       json.data.forEach(function(element){
          element._cd_message_per_day = true;
        });

        filters.selectAll(".bar")
           .selectAll("rect")
           .style("fill","steelblue");

        if (clicked_rect !== d){

          var all_dates = new Set();

          for (var i=0;  i < d.length; i++ ){
            all_dates.add(d[i].key)
          };

          d3.select(this)
             .style("fill", "purple");

          json.data.forEach(function(element){
               element._cd_message_per_day = false;
          });

          json.data
              .filter(function(e){return all_dates.has(String(e.date));})
              .forEach(function(element){element._cd_message_per_day = true;});
           clicked_rect = d;
        }
        else {
          clicked_rect = null;
        }
        create_scatterplot();
     });

  bar.append("text")
     .attr("dy", ".75em")
     .attr("y", 6)
     .attr("x", function(d) { return x3(d.length) + 12 ; })
     .attr("text-anchor", "middle")
     .text(function(d) { return d.length; })
     .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");

  filters.append("g")
     .attr("class", "y_hist")
     .attr("transform", "translate(" + (margin3.left) + "," + margin3.top + ")")
     .call(d3.axisLeft(y3));

}

function zoomed(){
 if (d3.event.sourceEvent && d3.event.sourceEvent.type === "brush") {return;}; // ignore zoom-by-brush
 var t = d3.event.transform;
 x1.domain(t.rescaleX(x2).domain());
 intialize_conditions();
 update_cd_date();
 create_scatterplot();

 if (x1.domain()[1] > x1.domain()[0]) {
     draw_histogram(json.data, x1.domain()[1], x1.domain()[0]);
 }
 else {
     draw_histogram(json.data, x1.domain()[0], x1.domain()[1])
 }

 axis_focus.select(".axis--x").call(xAxis1);

 density_date.select(".brush")
    .call(brush.move, x1.range().map(t.invertX, t));
}

function brushed() {
  if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom"){return;}; // ignore brush-by-zoom
  var s = d3.event.selection || x2.range();
  x1.domain(s.map(x2.invert, x2));
  intialize_conditions();
  update_cd_date();
  create_scatterplot();

  if (x1.domain()[1] > x1.domain()[0]) {
      draw_histogram(json.data, x1.domain()[1], x1.domain()[0]);
      }
  else {
      draw_histogram(json.data, x1.domain()[0], x1.domain()[1])
  }

  axis_focus.select(".axis--x").call(xAxis1);

  density_date.select(".zoom")
   .call(zoom.transform, d3.zoomIdentity
                            .scale(width / (s[1] - s[0]))
                            .translate(-s[0], 0)
        );
}

function create_scatterplot(){
update_visible();
context_canvas.clearRect(0, 0, canvas.width, canvas.height);
json.data.filter(function(d){return (d._visible);})
.forEach(function(d){
    context_canvas.beginPath();
    context_canvas.arc(margin1.left + x1(d.date), y1(d.time), 2, 0,  2 * Math.PI, true);
    context_canvas.fill()
    context_canvas.closePath();
})
}

getDate = function(date){
string = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate();
return parseUTCDate(string);
}

getTime = function(date){ //Remove the ":" in order to match the correct format
return date.getHours() + date.getMinutes()/60;
};

Date.prototype.getWeek = function() {
 var date = new Date(this.getTime());
  date.setHours(0, 0, 0, 0);
 // Thursday in current week decides the year.
 date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
 // January 4 is always in week 1.
 var week1 = new Date(date.getFullYear(), 0, 4);
 // Adjust to Thursday in week 1 and count number of weeks from date to week1.
 return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                       - 3 + (week1.getDay() + 6) % 7) / 7);
}

function sortByDateAscending(a, b) {
     // Dates will be cast to numbers automagically:
     return (parseUTCDate2(a.key) - parseUTCDate2(b.key));
 }

  </script>

</body>
