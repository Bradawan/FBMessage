<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="../d3/d3.js"></script>
  <style>

  .area {
    fill: steelblue;
    clip-path: url(#clip);
  }

  .zoom {
    cursor: move;
    fill: none;
    pointer-events: all;
  }

  div.tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 120px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightsteelblue;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
  }

  .bar_mpd text {
    fill: purple;
    font: 15px sans-serif;
  }

  .bar_mpd rect {
      stroke: white ;
      stroke-width: 2px;
      stroke-opacity: 0.0;
    }

  .bar_rs text {
    fill: purple;
    font: 15px sans-serif;
  }
  </style>
</head>
<body>
  <div>
    <div id="density_time" style="background-color: blue; width: 10%; height: 800px; display: inline-block;"></div>
    <div id="main" style="background-color: white; width: 70%; vertical-align: top; height: 800px; display: inline-block;">
      <canvas></canvas>
    </div>
    <div id="filters" style="background-color: green; width:19%; height: 800px; float: right; vertical-align: top; display: inline-block;"></div>
    <div id="place_holder" style="background-color: yellow; width: 10%; height: 150px; display: inline-block;"></div>
    <div id="density_date" style="background-color: red; width: 70%; height: 150px; display: inline-block;"></div>
    <div id="message_displayer" style="background-color: purple; width: 19%; height: 150px; display: inline-block;"></div>
  </div>

  <script>

var json;
// Define div, svg, etc..
{
    var div_density_time = d3.select('#density_time')
    var div_main = d3.select('#main')
    var div_filters = d3.select('#filters')
    var div_density_date = d3.select('#density_date')
    var div_message_displayer = d3.select('#message_displayer')

    var canvas = document.querySelector("canvas"),
        context_canvas = canvas.getContext("2d");

    var div_filters_2 = document.getElementById("filters")
    var div_main_2 = document.getElementById("main")
    var div_density_date_2 = document.getElementById("density_date")
    var div_density_time_2 = document.getElementById("density_time")
    var div_message_displayer_2 = document.getElementById("message_displayer")

}

//Define heights and widths
{
  var margin1 = {
    top: 20,
    right: 50,
    bottom: 50,
    left: 70,
  };
  var margin2 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 70,
  };
  var margin3 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 30,
  };
  var margin4 = {
    top: 20,
    right: 20,
    bottom: 50,
    left: 70,
  };
  var margin5 = {
    top: 30,
    right: 10,
    bottom: 10,
    left: 10,
  };

  var width = window.innerWidth;
  var height = window.innerHeight;
  var w1 = div_main_2.clientWidth - margin1.left - margin1.right;
  var h1 = div_main_2.clientHeight - margin1.top - margin1.bottom;
  var w2 = div_density_date_2.clientWidth - margin2.left - margin2.right;
  var h2 = div_density_date_2.clientHeight - margin2.top - margin2.bottom;
  var w3 = div_filters_2.clientWidth - margin3.left - margin3.right;
  var h3 = div_filters_2.clientHeight - margin3.top - margin3.bottom;
  var w4 = div_density_time_2.clientWidth - margin4.left - margin4.right;
  var h4 = div_density_time_2.clientHeight - margin4.top - margin4.bottom;
  var h5 = div_message_displayer_2.clientHeight - margin5.top - margin5.bottom;
  var w5 = div_message_displayer_2.clientWidth - margin5.top - margin5.bottom;

  canvas.width = w1 + margin1.left;
  canvas.height = h1;
}

// Define div, svg, etc..
{
  var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

  var body = d3.select("body");

  var density_date = div_density_date
      .append("svg")
      .attr("height", (h2 + margin2.top + margin2.bottom))
      .attr("width", (w2 + margin2.left + margin2.right));

  var density_time = div_density_time
      .append("svg")
      .attr("height", (h4 + margin4.top + margin4.bottom))
      .attr("width", (w4 + margin4.left + margin4.right));

  var axis_date_focus = div_main
      .append("svg")
      .attr("width", (w1 + margin1.left + margin1.right))
      .attr("height", margin1.bottom);

  var axis_time_focus = div_main
      .append("svg")
      .attr("width", margin1.left)
      .attr("height", h1 + margin1.bottom + margin1.top);

  var filters = div_filters
      .append("svg")
      .attr("height", (h3 + margin3.top + margin3.bottom))
      .attr("width", (w3 + margin3.left + margin3.right));

  var message_displayer = div_message_displayer
      .append("svg")
      .attr("height", h5 + margin5.top + margin5.bottom)
      .attr("width", w5 + margin5.left + margin5.right);
}

//Define parsers
{
  var parseUTCDateHour = d3.timeParse("%Y-%m-%dT%H:%M%Z");
  var parseUTCDate = d3.timeParse("%Y-%m-%d");
  var parseUTCDate2 = d3.timeParse("%W-%m-%Y");
}

// Defin constants
{
  var min_time = new Date(2000, 0, 1);
  var max_time = new Date(2000, 0, 1);
  max_time.setHours(23);
  max_time.setMinutes(59);
}

// Define scales and axes
{
  //Main canvas
  var x1 = d3.scaleTime()
            .range([0, w1]);

  var y1 = d3.scaleTime()
            .domain([min_time, max_time])
            .range([0,h1]);

  var xAxis1 = d3.axisBottom()
            .scale(x1);

  var yAxis1 = d3.axisLeft()
            .scale(y1);

  // Density date
  var x2 = d3.scaleTime()
            .range([0, w2]);

  var y2 = d3.scaleLinear()
            .range([h2,0]);

  var xAxis2 = d3.axisBottom()
              .scale(x2);

  // Histogram Messages per day
  var x3 = d3.scaleLinear()
              .range([0, w3]);

  var y3 = d3.scaleLinear()
              .rangeRound([0,h3/3]);

  // Density time
  var x4 = d3.scaleLinear()
              .range([0, w3]);

  var y4 = d3.scaleTime()
            .range([0, h4]);

  var yAxis4 = d3.axisLeft()
              .scale(y4);

  // Histrogram Received/Sent
  var x5 = d3.scaleLinear()
              .range([0, w3]);

  var y5 = d3.scaleLinear()
              .rangeRound([0,h3/6]);
}

//Defin brush and zoom
{
  var brush_date = d3.brushX()
      .extent([[0, margin2.top], [w2, margin2.top + h2]])
      .on("brush end", brushed_date);

  var brush_time = d3.brushY()
      .extent([[margin4.left, 0], [margin4.left + w4, h4]])
      .on("brush end", brushed_time);

  var zoom = d3.zoom()
    .scaleExtent([1, Infinity])
    .translateExtent([[0, margin2.top], [w2, margin2.top + h2]])
    .extent([[0, margin2.top], [w2, margin2.top + h2]])
    .on("zoom", zoomed);
}

//Load data
var data =  d3.json("short_flat_messages.json", function(json_file){
  json = json_file;
  parse_date()
  intialize_conditions()
  add_message_displayer();

  //initialize domains
  var mindate_total = d3.min(json.data, function(d){return d.date}),
      maxdate_total = d3.max(json.data, function(d){return d.date});

  x1.domain([mindate_total, maxdate_total]);
  x2.domain([mindate_total, maxdate_total]);

  create_scatterplot();

  axis_date_focus.append('g')
    .attr('transform', 'translate(' + margin1.left + ',' + 0 + ')')
    .attr('class', 'x axis--x')
    .call(xAxis1);

  axis_time_focus.append('g')
    .attr('transform', 'translate(' + (margin1.left ) + ',' + 0 + ')')
    .attr('class', 'y axis--y')
    .call(yAxis1);

  draw_density_date();
  draw_density_time();

  draw_histogram_mpd();
  //draw_histogram_rs()

  density_date.append("g")
        .attr("class", "brush")
        .call(brush_date)
        .call(brush_date.move, x2.range())
        .attr('transform', 'translate(' + margin2.left + ',' + 0 + ')');

  density_time.append("g")
        .attr("class", "brush")
        .call(brush_time)
        .call(brush_time.move, y4.range())
        .attr('transform', 'translate(' + 0 + ',' + margin4.top + ')');
});

function add_message_displayer(){
  d3.select(canvas).on("mousemove", function() {

    var find_date = x1.invert(d3.event.clientX - canvas.getBoundingClientRect().left - margin1.left);
    find_date.setHours(0, 0, 0, 0)
    var find_time = y1.invert(d3.event.clientY - canvas.getBoundingClientRect().top)
    var message_tooltip = json.data.filter(function(d){
      return (d.date == String(find_date) && precisionRound(d.time,1) === precisionRound(find_time,1))
    })

    if (message_tooltip.length > 0 ){
      message_displayer.selectAll("text").remove();
      message_displayer.append("text")
        .attr('transform', 'translate(' + margin5.left + ',' + margin5.top + ')')
        .attr("dy", "0em")
        .text(message_tooltip[0].date)

      message_displayer.append("text")
      .attr("dy", "1em") // you can vary how far apart it shows up
      .text(message_tooltip[0].message)
    }

  })
}

function parse_date(){
  json.data.forEach(function(d){
     date = d.date;
     date = parseUTCDateHour(date.substring(0, date.length - 3) + date.substring(date.length - 2, date.length));
     d.time = getTime(date);
     d.date = getDate(date);
  })
};

function intialize_conditions(){
  json.data.forEach(function(d){
   d._cd_date = true;
   d._cd_sent_received = true;
   d._cd_message_per_day = true;
   d._visible = true;
  })
}

function update_cd_date(){
  json.data.forEach(function(d){
   d._cd_date = d.date > x1.domain()[0] && d.date < x1.domain()[1]
  })
}

function update_visible(){
  json.data.forEach(function(d){
    d._visible = d._cd_date && d._cd_sent_received && d._cd_message_per_day;
  })
}

function draw_density_date(){
  var nested_data = d3.nest().key(function(d){
  return d.date.getWeek() + '-' + d.date.getMonth() + '-' + d.date.getFullYear();})
  .rollup(function(leaves) {
      return  leaves.length
  })
  .entries(json.data);

  nested_data = nested_data.sort(sortByDateAscending);

  var max_message = d3.max(nested_data, function(d){return d.value});

  y2.domain([0, max_message]);

  var area = d3.area()
    .curve(d3.curveBasisOpen)
    .x(function(d) { return x2(parseUTCDate2(d.key));})
    .y0(h2)
    .y1(function(d) { return y2(d.value); });

  density_date.append("path")
      .datum(nested_data)
      .attr("class", "area")
      .attr("d", area)
      .attr('transform', 'translate(' + margin2.left + ',' + (margin2.top) + ')')

  density_date.append('g')
    .attr('transform', 'translate(' + margin2.left + ',' + (h2 + margin2.top) + ')')
    .attr('class', 'x axis--x')
    .call(xAxis2);
}

function draw_density_time(){
  /*
  var nested_data = d3.nest().key(function(d){
  return d.date.getWeek() + '-' + d.date.getMonth() + '-' + d.date.getFullYear();})
  .rollup(function(leaves) {
      return  leaves.length
  })
  .entries(json.data);

  nested_data = nested_data.sort(sortByDateAscending);

  var max_message = d3.max(nested_data, function(d){return d.value});

  y4.domain([0, max_message]);

  var area = d3.area()
    .curve(d3.curveBasisOpen)
    .x(function(d) { return x4(parseUTCDate2(d.key));})
    .y0(h4)
    .y1(function(d) { return y4(d.value); });

  density_date.append("path")
      .datum(nested_data)
      .attr("class", "area")
      .attr("d", area)
      .attr('transform', 'translate(' + margin4.left + ',' + (margin4.top) + ')')
` */
  density_time.append('g')
    .attr('transform', 'translate(' + margin4.left + ',' + (margin4.top) + ')')
    .attr('class', function(d) {console.log("lkj"); return 'y axis--y'})
    .call(yAxis4);
}

function draw_histogram_rs(){

  //Remove old histogram
  filters.selectAll('.bar_rs')
     .remove();
  filters.selectAll('.y_hist_rs')
     .remove();

  //Create nested dataset
  var nested_data_rs = d3.nest()
     .key(function(d){return d.sent;})
     .rollup(function(array) {return array.length})
     .entries(json.data.filter(function(d){return d._visible;}));

  y5.domain([0, 2]);

  // Define domain horizontal axis
  var nb_max_message_per_bar = d3.max(nested_data_rs, function(d) {return d.value;})
  x5.domain([0, nb_max_message_per_bar])

  var bar = filters.selectAll(".bar_rs")
   .data(nested_data_rs)
   .enter().append("g")
     .attr("class", "bar_rs")
     .attr("transform", function(d, i) { return "translate(" + 0 + "," + y5(i) + ")"; });

  var clicked_rs = null;

  bar.append("rect")
     .style("fill", "steelblue")
     .attr("y", 1)
     .attr("height", y5(1))
     .attr("width", function(d) {console.log(x5(d.value)); return x5(d.value); })
     .attr("transform", "translate(" + margin3.left + "," + (margin3.top + y3.range()[1]) + ")")
     .on("click", function(d){
       json.data.forEach(function(element){
          element._cd_sent_received = true;
       });

       filters.selectAll(".bar_rs")
           .selectAll("rect")
           .style("fill","steelblue");

       if (clicked_rs !== d){
          d3.select(this).style("fill", "purple");

          json.data.forEach(function(element){
               element._cd_sent_received = false;
          });

          json.data
              .filter(function(e){return String(e.sent) == d.key;})
              .forEach(function(element){element._cd_sent_received = true;});
          clicked_rs = d;
        } else {
          clicked_rs = null;
        }
        create_scatterplot();
     });

  bar.append("text")
     .attr("dy", ".75em")
     .attr("y", 6)
     .attr("x", function(d) { return x3(d.length) + 12 ; })
     .attr("text-anchor", "middle")
     .text(function(d) { return d.length; })
     .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");

  filters.append("g")
     .attr("class", "_rs")
     .attr("transform", "translate(" + (margin3.left) + "," + margin3.top + ")")
     .call(d3.axisLeft(y3));

}

function draw_histogram_mpd(){

  //Remove old histogram
  filters.selectAll('.bar_mpd')
     .remove();
  filters.selectAll('.y_hist_mpd')
     .remove();

  //Create nested dataset
  var nested_data_hist = d3.nest()
     .key(function(d){return d.date;})
     .rollup(function(leaves) {return leaves.length})
     .entries(json.data.filter(function(d){return d._visible;}));

  //Define domain vertical axis
  var min_num = d3.min(nested_data_hist, function(d){return d.value}),
      max_num = d3.max(nested_data_hist, function(d){return d.value});

  y3.domain([min_num,max_num]);

  var histogram = d3.histogram()
     .value(function(d) {return +d.value;})
     .domain(y3.domain())
     .thresholds(y3.ticks(10));

  var bins = histogram(nested_data_hist);

  // Define domain horizontal axis
  var nb_max_message_per_bar = d3.max(bins, function(d) {return d.length;})
  x3.domain([0, nb_max_message_per_bar])

  var bar = filters.selectAll(".bar_mpd")
   .data(bins)
   .enter().append("g")
     .attr("class", "bar_mpd")
     .attr("transform", function(d) { return "translate(" + 0 + "," + y3(d.x0) + ")"; });

  var clicked_rect = null;

  bar.append("rect")
     .style("fill", "steelblue")
     .attr("y", 1)
     .attr("height", y3(bins[0].x1) - y3(bins[0].x0) - 1)
     .attr("width", function(d) {return x3(d.length); })
     .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")")
     .on("mouseover", function () {d3.select(this).style("stroke-opacity", 1);})
     .on("mouseout", function () {d3.select(this).style("stroke-opacity", 0.0);})
     .on("click", function(d){
       json.data.forEach(function(element){
          element._cd_message_per_day = true;
        });

        filters.selectAll(".bar_mpd")
           .selectAll("rect")
           .style("fill","steelblue");

        if (clicked_rect !== d){

          var all_dates = new Set();

          for (var i=0;  i < d.length; i++ ){
            all_dates.add(d[i].key)
          };

          d3.select(this)
             .style("fill", "purple");

          json.data.forEach(function(element){
               element._cd_message_per_day = false;
          });

          json.data
              .filter(function(e){return all_dates.has(String(e.date));})
              .forEach(function(element){element._cd_message_per_day = true;});
           clicked_rect = d;
        }
        else {
          clicked_rect = null;
        }
        create_scatterplot();
     });

  bar.append("text")
     .attr("dy", ".75em")
     .attr("y", 6)
     .attr("x", function(d) { return x3(d.length) + 12 ; })
     .attr("text-anchor", "middle")
     .text(function(d) { return d.length; })
     .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");

  filters.append("g")
     .attr("class", "y_hist_mpd")
     .attr("transform", "translate(" + (margin3.left) + "," + margin3.top + ")")
     .call(d3.axisLeft(y3));
}

function zoomed(){
   if (d3.event.sourceEvent && d3.event.sourceEvent.type === "brush") {return;}; // ignore zoom-by-brush
   var t = d3.event.transform;
   x1.domain(t.rescaleX(x2).domain());
   intialize_conditions();
   update_cd_date();
   create_scatterplot();

   if (x1.domain()[1] > x1.domain()[0]) {
       draw_histogram_mpd();
   }
   else {
       draw_histogram_mpd()
   }

   axis_date_focus.select(".axis--x").call(xAxis1);
   axis_time_focus.select(".axis--y").call(yAxis1);

   density_date.select(".brush")
      .call(brush_date.move, x1.range().map(t.invertX, t));
}

function brushed_date() {
  if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom"){return;}; // ignore brush-by-zoom
  var s = d3.event.selection || x2.range();
  x1.domain(s.map(x2.invert, x2));
  intialize_conditions();
  update_cd_date();
  create_scatterplot();

  if (x1.domain()[1] > x1.domain()[0]) {
      draw_histogram_mpd();
      }
  else {
      draw_histogram_mpd()
  }

  axis_date_focus.select(".axis--x").call(xAxis1);

  density_date.select(".zoom")
   .call(zoom.transform, d3.zoomIdentity
                            .scale(width / (s[1] - s[0]))
                            .translate(-s[0], 0)
        );
}

function brushed_time() {
  if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom"){return;}; // ignore brush-by-zoom
  var s = d3.event.selection || y4.range();
  y1.domain(s.map(y4.invert, y4));
  intialize_conditions();
  update_cd_date();
  create_scatterplot();

  if (y1.domain()[1] > y1.domain()[0]) {
      draw_histogram_mpd();
      }
  else {
      draw_histogram_mpd()
  }

  axis_date_focus.select(".axis--y").call(yAxis1);

  density_date.select(".zoom")
   .call(zoom.transform, d3.zoomIdentity
                            .scale(width / (s[1] - s[0]))
                            .translate(-s[0], 0)
        );
}

function create_scatterplot(){
  update_visible();
  context_canvas.clearRect(0, 0, canvas.width, canvas.height);
  json.data.filter(function(d){return (d._visible);})
  .forEach(function(d){
      context_canvas.beginPath();
      context_canvas.arc(margin1.left + x1(d.date), y1(d.time), 2, 0,  2 * Math.PI, true);
      context_canvas.fill()
      context_canvas.closePath();
  })
}

getDate = function(date){
  string = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate();
  return parseUTCDate(string);
}

getTime = function(date){ //Remove the ":" in order to match the correct format
  var day = new Date(2000, 0, 1);
  day.setHours(date.getHours());
  day.setMinutes(date.getMinutes());
  return day;
};

Date.prototype.getWeek = function() {
   var date = new Date(this.getTime());
    date.setHours(0, 0, 0, 0);
   // Thursday in current week decides the year.
   date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
   // January 4 is always in week 1.
   var week1 = new Date(date.getFullYear(), 0, 4);
   // Adjust to Thursday in week 1 and count number of weeks from date to week1.
   return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000
                         - 3 + (week1.getDay() + 6) % 7) / 7);
}

function sortByDateAscending(a, b) {
   // Dates will be cast to numbers automagically:
   return (parseUTCDate2(a.key) - parseUTCDate2(b.key));
}

function precisionRound(number, precision) {
   var factor = Math.pow(10, precision);
   return Math.round(number * factor) / factor;
}

  </script>

</body>
